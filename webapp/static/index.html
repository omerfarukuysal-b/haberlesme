<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>RPI Cluster Control</title>
  <style>
    body { font-family: sans-serif; margin: 24px; }
    .row { display:flex; gap:16px; align-items:center; margin:8px 0; flex-wrap: wrap; }
    .card { border:1px solid #ddd; border-radius:10px; padding:12px; margin:10px 0; }
    .muted { color:#666; font-size: 0.9em; }
    button { padding: 8px 10px; cursor: pointer; }
    input, select { padding: 6px 8px; }
    pre { background:#f6f6f6; padding:10px; border-radius:8px; overflow:auto; }
    .nodes-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 10px; }
    .node-card { transition: transform 0.05s ease-in-out; }
    .node-card:hover { transform: scale(1.01); }
    .selected { border-color: #333; box-shadow: 0 0 0 2px rgba(0,0,0,0.08); }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; font-size: 0.85em; }
    .online { background:#e9f7ef; }
    .offline { background:#fdecea; }
  </style>
</head>
<body>
  <h2>Mesh Network Control Panel</h2>
  <div class="muted">
    Her node, ağdaki diğer tüm node'lara doğrudan komut gönderebilir ve alabilir.
  </div>

  <!-- NODE LIST -->
  <div class="card">
    <div class="row">
      <button onclick="refreshNodes()">Refresh</button>
      <span id="status" class="muted"></span>
      <span class="muted">Seçili node: <b id="selNode">-</b></span>
    </div>

    <div id="nodes" class="nodes-grid"></div>
  </div>

  <!-- SELECTED TELEMETRY -->
  <div class="card">
    <h3>Selected Node Telemetry</h3>
    <div class="muted">Bir node kartına tıkla. Telemetri her 1 saniyede otomatik güncellenir.</div>
    <pre id="telemetryView">{}</pre>
  </div>

  <!-- COMMAND -->
  <div class="card">
    <h3>Command</h3>
    <div class="muted">İzinli aksiyonlar: hostname / uptime / echo</div>

    <div class="row">
      <label>Target ID:</label>
      <input id="target" type="number" value="1" min="1" max="255"/>

      <label>Action:</label>
      <select id="action">
        <option value="hostname">hostname</option>
        <option value="uptime">uptime</option>
        <option value="echo">echo</option>
        <option value="set_msg">set_msg (Update Status)</option> </select>
      </select>

      <label>Arg:</label>
      <input id="arg" type="text" value="hello mesh" />

      <button onclick="sendCmd()">Send Command</button>
    </div>

    <pre id="cmdResult">{}</pre>
  </div>

<script>
let selectedId = null;

// --- helpers ---
function escapeHtml(s) {
  return (s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

// --- API calls ---
async function refreshNodes() {
  try {
    document.getElementById("status").innerText = "loading...";
    const res = await fetch("/api/nodes");
    const data = await res.json();
    document.getElementById("status").innerText = data.nodes ? "ok" : "error";

    const root = document.getElementById("nodes");
    root.innerHTML = "";

    if (!data.nodes) {
      root.innerText = JSON.stringify(data);
      return;
    }

    // render node cards (mesh mode - tüm node'lar status döndürür)
    for (const n of data.nodes) {
      const div = document.createElement("div");
      div.className = "card node-card" + ((selectedId === n.id) ? " selected" : "");
      div.style.cursor = "pointer";
      div.onclick = () => selectNode(n.id);

      const status = n.status === "online" ? "ONLINE ✅" : "OFFLINE ❌";
      const badge = `<span class="pill ${n.status === "online" ? "online" : "offline"}">${status}</span>`;

      div.innerHTML = `
        <div class="row" style="justify-content: space-between;">
          <div><b>Node ${n.id}</b> (${n.hostname})</div>
          <div>${badge}</div>
        </div>
        <div class="muted">${n.ip}:${n.port}</div>
        <div style="font-size:0.85em; color:#0056b3; margin-top:4px;">
           msg: ${escapeHtml(n.telemetry.message || '-')}
        </div>
      `;

      root.appendChild(div);
    }
  } catch (e) {
    document.getElementById("status").innerText = "error";
    console.error(e);
  }
}

async function selectNode(id) {
  selectedId = id;
  document.getElementById("selNode").innerText = id;
  document.getElementById("target").value = id;

  // refresh visual selection border
  await refreshNodes();

  // fetch telemetry immediately
  await refreshTelemetryOnce();
}

// async function refreshTelemetryOnce() {
//   if (selectedId == null) return;
//   try {
//     const res = await fetch(`/api/telemetry/${selectedId}`);
//     const data = await res.json();
//     document.getElementById("telemetryView").innerText = JSON.stringify(data, null, 2);
//   } catch (e) {
//     document.getElementById("telemetryView").innerText = JSON.stringify({ok:false, error:"fetch failed"}, null, 2);
//     console.error(e);
//   }
// }
async function refreshTelemetryOnce() {
  if (selectedId == null) return;
  try {
    const res = await fetch(`/api/telemetry/${selectedId}`);
    const data = await res.json();
    
    // 1. Ham JSON'u yine göster (Debug için)
    document.getElementById("telemetryView").innerText = JSON.stringify(data, null, 2);

    // 2. Tablo Oluşturma Mantığı
    let detailsHtml = "";
    
    // Telemetri verisi var mı kontrol et
    if (data.telemetry) {
        const tx = data.telemetry.tx_details || {};
        const rx = data.telemetry.rx_details || {};
        
        // TX ve RX anahtarlarını birleştir (tüm komşuları bul)
        const neighbors = new Set([...Object.keys(tx), ...Object.keys(rx)]);
        
        if (neighbors.size > 0) {
            detailsHtml += `
            <table border="1" style="border-collapse: collapse; width: 100%; margin-top: 10px; text-align: center;">
                <tr style="background-color: #f0f0f0;">
                    <th>Komşu Node</th>
                    <th>Giden (TX)</th>
                    <th>Gelen (RX)</th>
                </tr>`;
                
            neighbors.forEach(nid => {
                const txCount = tx[nid] || 0;
                const rxCount = rx[nid] || 0;
                // Paket kaybı tahmini (Basit renk kodlaması)
                // (Not: RX tarafında ne kadar olması gerektiğini bilmediğimiz için 
                // sadece sayıları gösteriyoruz)
                detailsHtml += `
                <tr>
                    <td>Node <b>${nid}</b></td>
                    <td style="color:blue">${txCount}</td>
                    <td style="color:green">${rxCount}</td>
                </tr>`;
            });
            detailsHtml += `</table>`;
        } else {
            detailsHtml = "<div class='muted'>Henüz trafik verisi yok.</div>";
        }
    }

    // Tabloyu ekrana basmak için bir alan bul veya oluştur
    let tableContainer = document.getElementById("trafficTable");
    if (!tableContainer) {
        // Eğer yoksa telemetryView altına ekle
        const pre = document.getElementById("telemetryView");
        tableContainer = document.createElement("div");
        tableContainer.id = "trafficTable";
        pre.parentNode.appendChild(tableContainer);
    }
    tableContainer.innerHTML = detailsHtml;

  } catch (e) {
    console.error(e);
  }
}

async function sendCmd() {
  try {
    const target = document.getElementById("target").value;
    const action = document.getElementById("action").value;
    const arg = document.getElementById("arg").value;

    const qs = new URLSearchParams({target, action, arg});
    const res = await fetch("/api/command?" + qs.toString(), { method: "POST" });
    const data = await res.json();
    document.getElementById("cmdResult").innerText = JSON.stringify(data, null, 2);
  } catch (e) {
    document.getElementById("cmdResult").innerText = JSON.stringify({ok:false, error:"command failed"}, null, 2);
    console.error(e);
  }
}

// initial + periodic refresh
refreshNodes();
setInterval(refreshNodes, 1000);

// selected telemetry periodic refresh
setInterval(refreshTelemetryOnce, 1000);
</script>
</body>
</html>
